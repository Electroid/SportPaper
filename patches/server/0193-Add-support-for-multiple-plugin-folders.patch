From 0c9d470785da41a9ed46866d38e8b894f3ff0cd8 Mon Sep 17 00:00:00 2001
From: VytskaLT <VytskaLT@protonmail.com>
Date: Tue, 15 Dec 2020 21:51:54 +0200
Subject: [PATCH] Add support for multiple plugin folders


diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 613582cc..78fbf7f1 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -25,6 +25,7 @@ import java.util.regex.Pattern;
 import javax.annotation.Nullable;
 import javax.imageio.ImageIO;
 
+import it.unimi.dsi.fastutil.objects.ObjectArrayList;
 import net.minecraft.server.*;
 
 import app.ashcon.sportpaper.server.WorldGenSettingsManager;
@@ -232,22 +233,26 @@ public final class CraftServer implements Server {
     public void loadPlugins() {
         pluginManager.registerInterface(JavaPluginLoader.class);
 
-        File pluginFolder = (File) console.options.valueOf("plugins");
+        List<File> pluginFolders = (List<File>) console.options.valuesOf("plugins");
+        List<File> existingPluginFolders = new ObjectArrayList<>(pluginFolders.size());
+        for (File pluginFolder : pluginFolders) {
+            if (pluginFolder.exists()) {
+                existingPluginFolders.add(pluginFolder);
+            } else {
+                pluginFolder.mkdir();
+            }
+        }
 
-        if (pluginFolder.exists()) {
-            Plugin[] plugins = pluginManager.loadPlugins(pluginFolder);
-            for (Plugin plugin : plugins) {
-                try {
-                    String message = String.format("Loading %s", plugin.getDescription().getFullName());
-                    plugin.getLogger().info(message);
-                    plugin.onLoad();
-                } catch (Throwable ex) {
-                    Logger.getLogger(CraftServer.class.getName()).log(Level.SEVERE, ex.getMessage() + " initializing " + plugin.getDescription().getFullName() + " (Is it up to date?)", ex);
-                    pluginFailedToLoad(plugin);
-                }
+        Plugin[] plugins = pluginManager.loadPlugins(existingPluginFolders);
+        for (Plugin plugin : plugins) {
+            try {
+                String message = String.format("Loading %s", plugin.getDescription().getFullName());
+                plugin.getLogger().info(message);
+                plugin.onLoad();
+            } catch (Throwable ex) {
+                Logger.getLogger(CraftServer.class.getName()).log(Level.SEVERE, ex.getMessage() + " initializing " + plugin.getDescription().getFullName() + " (Is it up to date?)", ex);
+                pluginFailedToLoad(plugin);
             }
-        } else {
-            pluginFolder.mkdir();
         }
     }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/Main.java b/src/main/java/org/bukkit/craftbukkit/Main.java
index d1ce7a86..958a54a4 100644
--- a/src/main/java/org/bukkit/craftbukkit/Main.java
+++ b/src/main/java/org/bukkit/craftbukkit/Main.java
@@ -28,11 +28,12 @@ public class Main {
                         .defaultsTo(new File("server.properties"))
                         .describedAs("Properties file");
 
-                acceptsAll(asList("P", "plugins"), "Plugin directory to use")
+                acceptsAll(asList("P", "plugins"), "Plugin directories to use")
                         .withRequiredArg()
                         .ofType(File.class)
                         .defaultsTo(new File("plugins"))
-                        .describedAs("Plugin directory");
+                        .withValuesSeparatedBy(';')
+                        .describedAs("Plugin directories");
 
                 acceptsAll(asList("h", "host", "server-ip"), "Host to listen on")
                         .withRequiredArg()
-- 
2.25.1

