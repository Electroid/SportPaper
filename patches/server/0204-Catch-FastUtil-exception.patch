From b2ddc219a40cba6680a96fbdd13b9e7679e03082 Mon Sep 17 00:00:00 2001
From: linsaftw <linsaftw@users.noreply.github.com>
Date: Tue, 27 Apr 2021 09:53:13 -0300
Subject: [PATCH] Catch FastUtil exception


diff --git a/src/main/java/net/minecraft/server/ChunkProviderServer.java b/src/main/java/net/minecraft/server/ChunkProviderServer.java
index e58c022b..2089cb81 100644
--- a/src/main/java/net/minecraft/server/ChunkProviderServer.java
+++ b/src/main/java/net/minecraft/server/ChunkProviderServer.java
@@ -414,7 +414,11 @@ public class ChunkProviderServer implements IChunkProvider {
             this.saveChunkNOP(chunk);
             this.chunks.remove(chunk.chunkKey); // CraftBukkit
             if (!auto && this.unloadQueue.contains(chunk.chunkKey)) {
-                this.unloadQueue.remove(chunk.chunkKey);
+                try {
+                    this.unloadQueue.remove(chunk.chunkKey);
+                } catch (Exception e) {
+                    // SportPaper - Catch possible NPEs (Concurrent modification?)
+                }
             }
 
             // Update neighbor counts
@@ -442,12 +446,16 @@ public class ChunkProviderServer implements IChunkProvider {
             // SportPaper start
             LongIterator iterator = unloadQueue.iterator();
             for (int i = 0; i < 100 && iterator.hasNext(); ++i) {
-                long chunkcoordinates = iterator.nextLong();
-                iterator.remove();
-                // SportPaper end
-                Chunk chunk = this.chunks.get(chunkcoordinates);
-                if (chunk == null) continue;
-                unloadChunk(chunk, true); // SportPaper - Move to own method
+                try {
+                    long chunkcoordinates = iterator.nextLong();
+                    iterator.remove();
+                    // SportPaper end
+                    Chunk chunk = this.chunks.get(chunkcoordinates);
+                    if (chunk == null) continue;
+                    unloadChunk(chunk, true); // SportPaper - Move to own method
+                } catch (Exception e) {
+                    // SportPaper - Catch possible NPEs (Concurrent modification?)
+                }
             }
             // CraftBukkit end
 
-- 
2.31.1

