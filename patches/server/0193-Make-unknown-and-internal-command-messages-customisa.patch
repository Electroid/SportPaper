From 33caddfe2015b8ad3ace67d7b9a78cd9d55bb0f7 Mon Sep 17 00:00:00 2001
From: VytskaLT <VytskaLT@protonmail.com>
Date: Fri, 4 Dec 2020 13:56:51 +0200
Subject: [PATCH] Make unknown and internal command messages customisable in
 PlayerCommandPreprocessEvent


diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 21747b92..cd984175 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -1319,7 +1319,10 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
 
         CraftPlayer player = this.getPlayer();
 
-        PlayerCommandPreprocessEvent event = new PlayerCommandPreprocessEvent(player, s, new LazyPlayerSet());
+        // SportPaper - make unknown command and internal error messages customisable
+        PlayerCommandPreprocessEvent event = new PlayerCommandPreprocessEvent(player, s, new LazyPlayerSet(),
+                org.spigotmc.SpigotConfig.unknownCommandMessage,
+                org.bukkit.ChatColor.RED + "An internal error occurred while attempting to perform this command");
         this.server.getPluginManager().callEvent(event);
 
         if (event.isCancelled()) {
@@ -1328,12 +1331,16 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
         }
 
         try {
-            if (this.server.dispatchCommand(event.getPlayer(), event.getMessage().substring(1))) {
+            if (this.server.dispatchCommand(event.getPlayer(), event.getMessage().substring(1), event.getUnknownCommandMessage())) { // SportPaper
                 SpigotTimings.playerCommandTimer.stopTiming(); // Spigot
                 return;
             }
         } catch (org.bukkit.command.CommandException ex) {
-            player.sendMessage(org.bukkit.ChatColor.RED + "An internal error occurred while attempting to perform this command");
+            // SportPaper start
+            if (event.getInternalErrorMessage() != null) {
+                player.sendMessage(event.getInternalErrorMessage());
+            }
+            // SportPaper end
             java.util.logging.Logger.getLogger(PlayerConnection.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
             SpigotTimings.playerCommandTimer.stopTiming(); // Spigot
             return;
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 613582cc..e4aab51d 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -619,8 +619,14 @@ public final class CraftServer implements Server {
         }
     }
 
+    // SportPaper start
     @Override
-    public boolean dispatchCommand(CommandSender sender, String commandLine) {
+    public boolean dispatchCommand(CommandSender sender, String commandLine) throws CommandException {
+        return dispatchCommand(sender, commandLine, org.spigotmc.SpigotConfig.unknownCommandMessage);
+    }
+    // SportPaper end
+
+    public boolean dispatchCommand(CommandSender sender, String commandLine, String unknownCommandMessage) { // SportPaper - make unknown command message customisable
         Validate.notNull(sender, "Sender cannot be null");
         Validate.notNull(commandLine, "CommandLine cannot be null");
 
@@ -651,7 +657,11 @@ public final class CraftServer implements Server {
             return true;
         }
 
-        sender.sendMessage(org.spigotmc.SpigotConfig.unknownCommandMessage);
+        // SportPaper start
+        if (unknownCommandMessage != null) {
+            sender.sendMessage(unknownCommandMessage);
+        }
+        // SportPaper end
 
         return false;
     }
-- 
2.25.1

